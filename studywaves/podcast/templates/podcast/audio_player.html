{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>StudyWaves</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: #121212;
      color: #FFFFFF;
      font-family: 'Helvetica Neue', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      padding: 20px;
    }

    h1 {
      margin-bottom: 40px;
      font-size: 28px;
      font-weight: 600;
      text-transform: capitalize;
      text-align: center;
      color: #FFFFFF;
    }

    .player-container {
      background-color: #1e1e1e;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .progress-container {
      width: 100%;
      height: 6px;
      background-color: #3e3e3e;
      border-radius: 4px;
      margin-bottom: 10px;
      cursor: pointer;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      background-color: #1DB954; /* Spotify green */
      width: 0%;
      border-radius: 4px;
      transition: width 0.2s;
    }

    .time-display {
      width: 100%;
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #bbb;
      margin-bottom: 30px;
    }

    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .toggle-button {
      background-color: #1DB954;
      border: none;
      border-radius: 50%;
      padding: 20px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background-color 0.2s;
    }

    .toggle-button:hover {
      background-color: #1ed760;
    }

    .toggle-button svg {
      width: 24px;
      height: 24px;
      fill: white;
    }

    .question-button {
      background-color: #4858e8;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 10px 15px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .question-button:hover {
      background-color: #3a47c0;
    }

    .question-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 10;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #2e2e2e;
      border-radius: 10px;
      padding: 25px;
      width: 90%;
      max-width: 500px;
    }

    .modal-header {
      margin-bottom: 20px;
      font-size: 18px;
    }

    .modal-input {
      width: 100%;
      background-color: #3e3e3e;
      border: none;
      border-radius: 5px;
      padding: 12px;
      color: white;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .modal-button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .cancel-button {
      background-color: #464646;
      color: white;
    }

    .submit-button {
      background-color: #1DB954;
      color: white;
    }

    .loading-indicator {
      display: none;
      text-align: center;
      margin-top: 15px;
      color: #bbb;
    }
    
  </style>
</head>
<body>
  <h1>{{ podcast.title }}</h1>
  <div class="player-container">
    <audio id="audio"></audio>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="time-display">
      <span id="currentTime">0:00</span>
      <span id="totalTime">0:00</span>
    </div>

    <div class="controls">
      <button class="toggle-button" id="playPauseBtn">
        <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        <svg id="pauseIcon" viewBox="0 0 24 24" style="display: none;"><path d="M6 19h4V5H6zm8-14v14h4V5h-4z"/></svg>
      </button>
      <button class="question-button" id="questionBtn">Ask a Question</button>
    </div>
  </div>

  <!-- Question Modal -->
  <div class="question-modal" id="questionModal">
    <div class="modal-content">
      <div class="modal-header">Ask a Question</div>
      <input type="text" class="modal-input" id="questionInput" placeholder="Type your question here...">
      <div class="loading-indicator" id="loadingIndicator">
        Generating response... This may take a moment.
      </div>
      <div class="modal-buttons">
        <button class="modal-button cancel-button" id="cancelBtn">Cancel</button>
        <button class="modal-button submit-button" id="submitBtn">Submit</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
    const audioFiles = [
      {% for file in files %}
        "/static/{{ file }}"{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];

    let currentIndex = 0;
    let totalDuration = 0;
    let durations = [];
    let timeOffsets = [0];
    let isPlaying = false;
    let scriptContent = "";
    let originalAudioFiles = [...audioFiles];

    const audio = document.getElementById('audio');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const playIcon = document.getElementById('playIcon');
    const pauseIcon = document.getElementById('pauseIcon');
    const progressBar = document.getElementById('progressBar');
    const progressContainer = document.getElementById('progressContainer');
    const currentTimeDisplay = document.getElementById('currentTime');
    const totalTimeDisplay = document.getElementById('totalTime');
    const questionBtn = document.getElementById('questionBtn');
    const questionModal = document.getElementById('questionModal');
    const questionInput = document.getElementById('questionInput');
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');

    // Load script content from the Django template
    function loadScript() {
      try {
        // Get script content passed from the Django view
        scriptContent = `{{ script|escapejs }}`;
        console.log("Script loaded successfully");
      } catch (error) {
        console.error("Error loading script:", error);
      }
    }

    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
    }

    function loadAudioMetadata(index) {
      return new Promise((resolve) => {
        const tempAudio = new Audio();
        tempAudio.src = audioFiles[index];
        tempAudio.addEventListener('loadedmetadata', () => resolve(tempAudio.duration));
        tempAudio.addEventListener('error', () => resolve(0));
      });
    }

    async function initializePlayer() {
      loadScript();
      
      durations = [];
      timeOffsets = [0];
      totalDuration = 0;
      
      for (let i = 0; i < audioFiles.length; i++) {
        const duration = await loadAudioMetadata(i);
        durations.push(duration);
        totalDuration += duration;
        if (i > 0) timeOffsets.push(timeOffsets[i - 1] + durations[i - 1]);
      }
      totalTimeDisplay.textContent = formatTime(totalDuration);
      
      // Only load audio if not already loaded
      if (!audio.src || currentIndex >= audioFiles.length) {
        loadAudio(0);
      }
    }

    function loadAudio(index) {
      if (index >= audioFiles.length) {
        console.error("Trying to load audio index out of bounds:", index);
        return;
      }
      
      audio.src = audioFiles[index];
      audio.load();
      currentIndex = index;
      if (isPlaying) audio.play();
    }

    function findFileAtTime(targetTime) {
      for (let i = 0; i < timeOffsets.length; i++) {
        if (i === timeOffsets.length - 1 || targetTime < timeOffsets[i + 1]) {
          return { index: i, offset: targetTime - timeOffsets[i] };
        }
      }
      return { index: 0, offset: 0 };
    }

    function updateProgress() {
      if (!isPlaying) return;
      const currentFileTime = audio.currentTime;
      const globalTime = timeOffsets[currentIndex] + currentFileTime;
      const progressPercent = (globalTime / totalDuration) * 100;
      progressBar.style.width = `${progressPercent}%`;
      currentTimeDisplay.textContent = formatTime(globalTime);
      requestAnimationFrame(updateProgress);
    }

    function seekTo(globalTime) {
      const { index, offset } = findFileAtTime(globalTime);
      if (index !== currentIndex) loadAudio(index);
      audio.currentTime = offset;
      currentTimeDisplay.textContent = formatTime(globalTime);
    }

    // Split script based on current playback position
    function splitScriptAtCurrentPosition() {
      if (!scriptContent) return { read: "", unread: "" };
      
      const currentFileTime = audio.currentTime;
      const globalTime = timeOffsets[currentIndex] + currentFileTime;
      const progressPercent = globalTime / totalDuration;
      
      // Estimate where in the script we are based on playback percentage
      const splitPosition = Math.floor(scriptContent.length * progressPercent);
      
      // Find the nearest line break for a cleaner split
      let adjustedSplit = splitPosition;
      while (adjustedSplit < scriptContent.length && scriptContent[adjustedSplit] !== '\n') {
        adjustedSplit++;
      }
      
      const read = scriptContent.substring(0, adjustedSplit);
      const unread = scriptContent.substring(adjustedSplit);
      
      return { read, unread };
    }

    // Auto-pause when question button is clicked
    questionBtn.addEventListener('click', () => {
      // Pause the audio
      if (isPlaying) {
        audio.pause();
        isPlaying = false;
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
      }
      
      questionModal.style.display = "flex";
    });

    // Submit question to the backend
    async function submitQuestion(question) {
      loadingIndicator.style.display = "block";
      questionInput.disabled = true;
      submitBtn.disabled = true;
      cancelBtn.disabled = true;
      
      const { read, unread } = splitScriptAtCurrentPosition();
      
      try {
        const response = await fetch('/api/ask-question/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            podcast_id: {{ podcast.id }},
            read: read,
            unread: unread,
            question: question
          })
        });

        if (response.ok) {
          const data = await response.json();
          
          // Save current position
          const wasPlaying = isPlaying;
          const currentPosition = timeOffsets[currentIndex] + audio.currentTime;
          
          // Insert the new audio files after the current file
          const staticPath = "{% static '' %}";
          const newAudioFiles = data.audioFiles.map(file => `${staticPath}${file}`);
          
          // Important: update at the right position
          const updatedAudioFiles = [
            ...audioFiles.slice(0, currentIndex + 1),
            ...newAudioFiles,
            ...audioFiles.slice(currentIndex + 1)
          ];
          
          // Update audio files array
          audioFiles.length = 0; // Clear array
          updatedAudioFiles.forEach(file => audioFiles.push(file));
          
          // Reinitialize player with new files
          await initializePlayer();
          
          // Seek to the previous position
          seekTo(currentPosition);
          
          // Restore play state if it was playing
          if (wasPlaying) {
            audio.play();
            isPlaying = true;
            playIcon.style.display = 'none';
            pauseIcon.style.display = 'block';
            updateProgress();
          }
          
          questionModal.style.display = "none";
          questionInput.value = "";
          
          console.log("Successfully added question response to playlist");
        } else {
          const errorData = await response.json();
          console.error("Error from server:", errorData);
          alert("Failed to process your question. Please try again.");
        }
      } catch (error) {
        console.error("Error submitting question:", error);
        alert("An error occurred. Please try again.");
      } finally {
        loadingIndicator.style.display = "none";
        questionInput.disabled = false;
        submitBtn.disabled = false;
        cancelBtn.disabled = false;
      }
    }

    // Get CSRF token from cookies
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    playPauseBtn.addEventListener('click', () => {
      if (isPlaying) {
        audio.pause();
        isPlaying = false;
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
      } else {
        audio.play();
        isPlaying = true;
        playIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
        updateProgress();
      }
    });

    audio.addEventListener('ended', () => {
      if (currentIndex < audioFiles.length - 1) {
        currentIndex++;
        loadAudio(currentIndex);
      } else {
        isPlaying = false;
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
      }
    });

    progressContainer.addEventListener('click', (e) => {
      const rect = progressContainer.getBoundingClientRect();
      const clickPosition = e.clientX - rect.left;
      const clickPercent = clickPosition / rect.width;
      const globalTime = totalDuration * clickPercent;
      seekTo(globalTime);
    });

    cancelBtn.addEventListener('click', () => {
      questionModal.style.display = "none";
      questionInput.value = "";
    });

    submitBtn.addEventListener('click', () => {
      const question = questionInput.value.trim();
      if (question) {
        submitQuestion(question);
      } else {
        alert("Please enter a question");
      }
    });

    // Close modal when clicking outside
    questionModal.addEventListener('click', (e) => {
      if (e.target === questionModal) {
        questionModal.style.display = "none";
        questionInput.value = "";
      }
    });

    // Initialize player
    initializePlayer();
  });
</script>
</body>
</html>